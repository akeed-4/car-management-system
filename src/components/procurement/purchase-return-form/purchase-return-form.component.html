<div class="container">
  <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
    <h2 class="text-2xl font-semibold text-gray-800">{{ 'PURCHASE_RETURN.CREATE_TITLE' | translate }}</h2>
    <a routerLink="/procurement/return" class="text-primary-600 hover:text-primary-800 transition duration-300 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 ml-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 9l-3 3m0 0l3 3m-3-3h7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
      <span>{{ 'PURCHASE_RETURN.BACK_TO_LIST' | translate }}</span>
    </a>
  </div>

  <div class="bg-white p-6 md:p-8 rounded-lg shadow-md">
    <form [formGroup]="returnForm" (ngSubmit)="saveReturn()">
       <!-- Return Header -->
      <section class="border-b pb-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">{{ 'PURCHASE_RETURN.HEADER' | translate }}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'PURCHASE_RETURN.RETURN_NUMBER' | translate }}</mat-label>
              <input matInput type="text" [value]="returnInvoiceNumber()" disabled>
            </mat-form-field>
          </div>
          <div>
            <div>
    <mat-form-field appearance="outline" class="form-field">
      <mat-label>{{ 'PURCHASE_RETURN.RETURN_DATE' | translate }}</mat-label>
      <input matInput [matDatepicker]="invoiceDatePicker" formControlName="returnDate" required>
      <mat-datepicker-toggle matSuffix [for]="invoiceDatePicker"></mat-datepicker-toggle>
      <mat-datepicker #invoiceDatePicker></mat-datepicker>
    </mat-form-field>
            </div>
    

          </div>
          <div>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'PURCHASE_RETURN.ORIGINAL_INVOICE' | translate }}</mat-label>
              <mat-select formControlName="originalInvoice" required>
                <mat-option [value]="null" disabled>{{ 'PURCHASE_RETURN.SELECT_INVOICE' | translate }}</mat-option>
                @for (invoice of originalInvoices(); track invoice.id) {
                  <mat-option [value]="invoice.id">{{ invoice.id }} - {{ invoice.supplierName }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>
         @if (selectedOriginalInvoice(); as originalInvoice) {
          <div class="mt-4 p-4 bg-gray-50 rounded-lg border text-sm">
            <p><span class="font-medium text-gray-500">{{ 'PURCHASE_RETURN.SUPPLIER' | translate }}:</span> <span class="font-semibold">{{originalInvoice.supplierName}}</span></p>
          </div>
        }
      </section>

      <!-- Return Items DataGrid -->
      <section class="mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">{{ 'PURCHASE_RETURN.ITEMS_HEADER' | translate }}</h3>
        <div class="datagrid-container">
          <dx-data-grid
            [dataSource]="returnItems()"
            [showBorders]="true"
            [showRowLines]="true"
            [showColumnLines]="true"
            [allowColumnReordering]="true"
            [allowColumnResizing]="true"
            [columnAutoWidth]="true"
            [wordWrapEnabled]="true"
            height="400px"
            class="professional-datagrid">

            <dxo-paging [enabled]="false"></dxo-paging>
            <dxo-scrolling mode="virtual"></dxo-scrolling>
            <dxo-filter-row [visible]="true"></dxo-filter-row>
            <dxo-header-filter [visible]="true"></dxo-header-filter>

            <dxi-column
              dataField="carDescription"
              [caption]="'PURCHASE_RETURN.CAR' | translate"
              [allowEditing]="false"
              [minWidth]="200"
              alignment="right">
            </dxi-column>

            <dxi-column
              dataField="originalQuantity"
              [caption]="'PURCHASE_RETURN.ORIGINAL_QTY' | translate"
              [allowEditing]="false"
              [width]="120"
              dataType="number"
              alignment="right">
            </dxi-column>

            <dxi-column
              dataField="unitPrice"
              [caption]="'PURCHASE_RETURN.UNIT_PRICE' | translate"
              [allowEditing]="false"
              [width]="120"
              dataType="number"
              format="currency"
              alignment="right">
              <dxo-format type="currency" currency="SAR"></dxo-format>
            </dxi-column>

            <dxi-column
              dataField="returnQuantity"
              [caption]="'PURCHASE_RETURN.RETURN_QTY' | translate"
              [width]="120"
              dataType="number"
              alignment="right">
              <dxo-lookup
                [dataSource]="getQuantityOptions"
                valueExpr="value"
                displayExpr="text">
              </dxo-lookup>
            </dxi-column>

            <dxi-column
              dataField="lineTotal"
              [caption]="'PURCHASE_RETURN.LINE_TOTAL' | translate"
              [allowEditing]="false"
              [width]="120"
              dataType="number"
              format="currency"
              alignment="right">
              <dxo-format type="currency" currency="SAR"></dxo-format>
            </dxi-column>

            <dxo-summary>
              <dxi-total-item
                column="lineTotal"
                summaryType="sum"
                [customizeText]="customizeTotalText">
              </dxi-total-item>
            </dxo-summary>

          </dx-data-grid>
        </div>
      </section>

      <!-- Financial Summary -->
      <section class="financial-summary">
        <div class="summary-card">
          <div class="summary-content">
            <p class="summary-label">{{ 'PURCHASE_RETURN.TOTAL' | translate }}</p>
            <p class="summary-amount">{{ totalAmount() | currency:'SAR':'symbol':'1.0-0' }}</p>
          </div>
        </div>
      </section>

      <!-- Form Actions -->
      <div class="form-actions">
        <a routerLink="/procurement/return" class="btn-cancel">
          {{ 'PURCHASE_RETURN.CANCEL' | translate }}
        </a>
        <button
          type="submit"
          [disabled]="!selectedOriginalInvoice() || totalAmount() === 0"
          class="btn-save">
          {{ 'PURCHASE_RETURN.SAVE' | translate }}
        </button>
      </div>
    </form>
  </div>
</div>