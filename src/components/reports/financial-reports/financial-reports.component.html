<div class="container mx-auto">
  <h2 class="text-xl font-semibold text-gray-800 mb-6">التقرير المالي (الأرباح والخسائر)</h2>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
      <p class="text-sm font-medium text-gray-500">إجمالي الإيرادات</p>
      <p class="text-2xl font-bold text-gray-800 mt-1">{{ totalRevenue() | currency:'SAR':'symbol':'1.0-0' }}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
      <p class="text-sm font-medium text-gray-500">تكلفة البضاعة المباعة</p>
      <p class="text-2xl font-bold text-red-600 mt-1">{{ totalCostOfGoodsSold() | currency:'SAR':'symbol':'1.0-0' }}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
      <p class="text-sm font-medium text-gray-500">إجمالي المصروفات</p>
      <p class="text-2xl font-bold text-red-600 mt-1">{{ totalOperatingExpenses() | currency:'SAR':'symbol':'1.0-0' }}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
      <p class="text-sm font-medium text-gray-500">صافي الربح</p>
      <p class="text-3xl font-bold text-green-600 mt-1">{{ netProfit() | currency:'SAR':'symbol':'1.0-0' }}</p>
    </div>
  </div>

  <!-- Detailed Profit Report Table -->
  <div class="bg-white p-6 rounded-lg shadow-md">
     <h3 class="text-xl font-semibold text-gray-700 mb-4">تفاصيل الأرباح لكل سيارة مباعة</h3>
     <div class="mb-4">
      <input 
        type="text" 
        placeholder="ابحث عن فاتورة/سيارة..."
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 transition duration-150 ease-in-out text-sm"
        (input)="onFilter($event)">
    </div>
     <div class="overflow-x-auto">
      <table class="min-w-full bg-white">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-right py-3 px-4 font-semibold text-sm text-gray-600 uppercase cursor-pointer" (click)="onSort('invoiceNumber')">
              رقم الفاتورة {{ getSortIcon('invoiceNumber') }}
            </th>
            <th class="text-right py-3 px-4 font-semibold text-sm text-gray-600 uppercase cursor-pointer" (click)="onSort('carDescription')">
              السيارة {{ getSortIcon('carDescription') }}
            </th>
            <th class="text-center py-3 px-4 font-semibold text-sm text-gray-600 uppercase cursor-pointer" (click)="onSort('quantity')">
              الكمية {{ getSortIcon('quantity') }}
            </th>
            <th class="text-right py-3 px-4 font-semibold text-sm text-gray-600 uppercase cursor-pointer" (click)="onSort('salePrice')">
              سعر البيع {{ getSortIcon('salePrice') }}
            </th>
            <th class="text-right py-3 px-4 font-semibold text-sm text-gray-600 uppercase cursor-pointer" (click)="onSort('costOfGoods')">
              تكلفة البضاعة {{ getSortIcon('costOfGoods') }}
            </th>
            <th class="text-right py-3 px-4 font-semibold text-sm text-gray-600 uppercase cursor-pointer" (click)="onSort('profit')">
              الربح {{ getSortIcon('profit') }}
            </th>
          </tr>
        </thead>
        <tbody class="text-gray-700">
          @for (item of filteredAndSortedProfitReport(); track item.invoiceNumber) {
            <tr class="border-b hover:bg-gray-50">
              <td class="py-3 px-4 text-sm font-mono whitespace-nowrap">{{ item.invoiceNumber }}</td>
              <td class="py-3 px-4 text-sm whitespace-nowrap">{{ item.carDescription }}</td>
              <td class="py-3 px-4 text-center text-sm whitespace-nowrap">{{ item.quantity }}</td>
              <td class="py-3 px-4 text-sm font-mono whitespace-nowrap">{{ item.salePrice | currency:'SAR' }}</td>
              <td class="py-3 px-4 text-sm font-mono whitespace-nowrap">{{ item.costOfGoods | currency:'SAR' }}</td>
              <td class="py-3 px-4 text-sm font-mono whitespace-nowrap font-bold"
                  [class.text-green-600]="item.profit > 0"
                  [class.text-red-600]="item.profit < 0">
                {{ item.profit | currency:'SAR' }}
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-500">
                لا توجد بيانات مبيعات لعرض التقرير المالي.
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>