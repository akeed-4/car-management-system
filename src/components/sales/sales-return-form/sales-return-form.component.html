<div class="container">
  <div class="page-header">
    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
      <h2 class="page-title">{{ 'SALES.RETURN.CREATE_TITLE' | translate }}</h2>
      <a routerLink="/sales/return" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 9l-3 3m0 0l3 3m-3-3h7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        <span>{{ 'SALES.RETURN.BACK_TO_LIST' | translate }}</span>
      </a>
    </div>
  </div>

  <div class="form-container">
    <form [formGroup]="returnForm" (ngSubmit)="saveReturn()">

      <!-- Return Header -->
      <section class="form-section">
        <h3 class="section-title">{{ 'SALES.RETURN.HEADER' | translate }}</h3>
        <div class="form-grid">
          <div class="form-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'SALES.RETURN.RETURN_NUMBER' | translate }}</mat-label>
              <input matInput type="text" [value]="returnInvoiceNumber()" disabled>
            </mat-form-field>
          </div>
          <div class="form-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'SALES.RETURN.RETURN_DATE' | translate }}</mat-label>
              <input matInput type="date" formControlName="returnDate" required>
            </mat-form-field>
          </div>
          <div class="form-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'SALES.RETURN.ORIGINAL_INVOICE' | translate }}</mat-label>
              <mat-select formControlName="originalInvoice" required>
                <mat-option [value]="null" disabled>{{ 'SALES.RETURN.SELECT_INVOICE' | translate }}</mat-option>
                @for (invoice of originalInvoices(); track invoice.id) {
                <mat-option [value]="invoice.id">{{ invoice.invoiceNumber }} - {{ invoice.customerName }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        @if (selectedOriginalInvoice(); as originalInvoice) {
          <div class="invoice-info-card">
            <p class="invoice-info-text">
              <span class="invoice-info-label">{{ 'INVOICE.CUSTOMER' | translate }}:</span>
              <span>{{originalInvoice.customerName}}</span>
            </p>
          </div>
        }
      </section>      <!-- Return Items DataGrid -->
      <section class="mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">{{ 'SALES.RETURN.ITEMS_HEADER' | translate }}</h3>
        <div class="datagrid-container">
          <dx-data-grid
            [dataSource]="returnItems()"
            [showBorders]="true"
            [showRowLines]="true"
            [showColumnLines]="true"
            [allowColumnReordering]="true"
            [allowColumnResizing]="true"
            [columnAutoWidth]="true"
            [wordWrapEnabled]="true"
            height="400px"
            class="professional-datagrid">

            <dxo-paging [enabled]="false"></dxo-paging>
            <dxo-scrolling mode="virtual"></dxo-scrolling>
            <dxo-filter-row [visible]="true"></dxo-filter-row>
            <dxo-header-filter [visible]="true"></dxo-header-filter>

            <dxi-column
              dataField="carDescription"
              [caption]="'SALES.RETURN.CAR' | translate"
              [allowEditing]="false"
              [minWidth]="200"
              alignment="right">
            </dxi-column>

            <dxi-column
              dataField="originalQuantity"
              [caption]="'SALES.RETURN.ORIGINAL_QTY' | translate"
              [allowEditing]="false"
              [width]="120"
              dataType="number"
              alignment="right">
            </dxi-column>

            <dxi-column
              dataField="unitPrice"
              [caption]="'SALES.RETURN.UNIT_PRICE' | translate"
              [allowEditing]="false"
              [width]="120"
              dataType="number"
              format="currency"
              alignment="right">
              <dxo-format type="currency" currency="SAR"></dxo-format>
            </dxi-column>

            <dxi-column
              dataField="returnQuantity"
              [caption]="'SALES.RETURN.RETURN_QTY' | translate"
              [width]="120"
              dataType="number"
              alignment="right">
              <dxo-lookup
                [dataSource]="getQuantityOptions"
                valueExpr="value"
                displayExpr="text">
              </dxo-lookup>
            </dxi-column>

            <dxi-column
              dataField="lineTotal"
              [caption]="'SALES.RETURN.LINE_TOTAL' | translate"
              [allowEditing]="false"
              [width]="120"
              dataType="number"
              format="currency"
              alignment="right">
              <dxo-format type="currency" currency="SAR"></dxo-format>
            </dxi-column>

            <dxo-summary>
              <dxi-total-item
                column="lineTotal"
                summaryType="sum"
                [customizeText]="customizeTotalText">
              </dxi-total-item>
            </dxo-summary>

          </dx-data-grid>
        </div>
      </section>

      <!-- Financial Summary -->
      <section class="financial-summary">
        <div class="summary-card">
          <div class="summary-content">
            <p class="summary-label">{{ 'SALES.RETURN.TOTAL' | translate }}</p>
            <p class="summary-amount">{{ totalAmount() | currency:'SAR':'symbol':'1.0-0' }}</p>
          </div>
        </div>
      </section>

      <!-- Form Actions -->
      <div class="form-actions">
        <a routerLink="/sales/return" class="btn-cancel">
          {{ 'SALES.RETURN.CANCEL' | translate }}
        </a>
        <button
          type="submit"
          [disabled]="returnForm.invalid || totalAmount() === 0"
          class="btn-save">
          {{ 'SALES.RETURN.SAVE' | translate }}
        </button>
      </div>
    </form>
  </div>
</div>