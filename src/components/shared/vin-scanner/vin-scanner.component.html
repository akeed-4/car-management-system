@if (isOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm" (click)="onCancel()">
    <div class="relative w-full max-w-2xl h-[80vh] m-4 bg-gray-900 rounded-lg shadow-xl overflow-hidden flex flex-col" (click)="$event.stopPropagation()">
      <!-- Video and Overlay -->
      <div class="relative flex-grow flex items-center justify-center">
        <video #video playsinline autoplay class="w-full h-full object-cover"></video>
        <!-- Scanner Overlay -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-11/12 md:w-4/5 h-24 border-4 border-white border-opacity-75 rounded-lg shadow-lg"></div>
        </div>
        <!-- Loading Spinner -->
        @if (isProcessing()) {
          <div class="absolute inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center">
            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-primary-400"></div>
            <p class="text-white text-lg mt-4 font-semibold">جاري تحليل الصورة...</p>
          </div>
        }
      </div>
      
      <!-- Error Message -->
      @if(error()) {
        <div class="absolute top-4 left-1/2 -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-10" role="alert">
          <strong class="font-bold">خطأ!</strong>
          <span class="block sm:inline ml-2">{{ error() }}</span>
        </div>
      }

      <!-- Controls -->
      <div class="bg-gray-900 bg-opacity-75 p-4 flex items-center justify-around">
          <button (click)="onCancel()" class="px-6 py-3 text-sm font-medium text-gray-200 bg-gray-600 rounded-full hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
            إلغاء
          </button>
          <button (click)="capture()" [disabled]="isProcessing()" class="p-4 bg-white rounded-full shadow-lg hover:bg-gray-200 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-white disabled:opacity-50">
            <svg class="w-10 h-10 text-primary-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h3l2-2h6l2 2h3v18H4V4zm8 14c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </button>
           <div class="w-24"></div> <!-- Spacer for symmetry -->
      </div>

      <!-- Hidden Canvas -->
      <canvas #canvas class="hidden"></canvas>
    </div>
  </div>
}
